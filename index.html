<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tokit</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; }
        .topics { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0; }
        .topic { padding: 10px 15px; border: none; border-radius: 20px; cursor: pointer; font-size: 16px; }
        .selected { background-color: #ff5722; color: white; }
        .video-container { display: flex; justify-content: center; margin: 20px auto; }
        #player { width: 320px; height: 560px; border-radius: 15px; overflow: hidden; }
        .controls { margin-top: 10px; display: flex; justify-content: center; gap: 10px; }
        .nav-btn { padding: 10px 15px; border: none; border-radius: 20px; cursor: pointer; font-size: 16px; }
        .coin-counter { font-size: 20px; margin-top: 20px; }
        .load-btn {
            padding: 12px 24px;
            background-color: #ff5722;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–∞—Å —Ç–µ–º—ã:</h2>
    <div class="topics">
        <button class="topic" onclick="toggleTopic(this)" value="—Å–ø–æ—Ä—Ç">üèãÔ∏è –°–ø–æ—Ä—Ç</button>
        <button class="topic" onclick="toggleTopic(this)" value="–∏–≥—Ä—ã">üéÆ –ò–≥—Ä—ã</button>
        <button class="topic" onclick="toggleTopic(this)" value="–º—É–∑—ã–∫–∞">üéµ –ú—É–∑—ã–∫–∞</button>
        <button class="topic" onclick="toggleTopic(this)" value="—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">üé≠ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</button>
        <button class="topic" onclick="toggleTopic(this)" value="–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</button>
        <button class="topic" onclick="toggleTopic(this)" value="—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏">üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</button>
        <button class="topic" onclick="toggleTopic(this)" value="–∞–≤—Ç–æ">üöó –ê–≤—Ç–æ</button>
        <button class="topic" onclick="toggleTopic(this)" value="–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</button>
        <button class="topic" onclick="toggleTopic(this)" value="–µ–¥–∞">üçî –ï–¥–∞</button>
        <button class="topic" onclick="toggleTopic(this)" value="–∑–¥–æ—Ä–æ–≤—å–µ">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</button>
    </div>

    <button class="load-btn" onclick="loadVideos()">–ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ</button>

    <div class="video-container">
        <div id="player"></div>
    </div>

    <div class="controls">
        <button class="nav-btn" onclick="prevVideo()">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="nav-btn" onclick="nextVideo()">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
    </div>

    <div class="coin-counter">
        üí∞: <span id="coins">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>

    <script>
        const API_KEY = "AIzaSyAajvPaSxDC8NMm1Yn50W2V2Ym_TIcm4x8";
        let selectedTopics = [];
        let videos = [];
        let currentIndex = 0;
        let player;
        let coins = null; // –ò–∑–º–µ–Ω–µ–Ω–æ —Å 0 –Ω–∞ null –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        let userId = 100;
        let videoDuration = 0;
        let isHalfWatched = false;
        let watchedTime = 0;
        let interval;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchInitialCoins();
            initYouTubePlayer();
        });

        async function fetchInitialCoins() {
            try {
                const response = await fetch(`/api/get-coins?userId=${userId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                coins = data.coins;
                updateCoinDisplay();
                console.log('–ú–æ–Ω–µ—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', coins);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–Ω–µ—Ç:', error);
                coins = 0;
                updateCoinDisplay();
            }
        }

        function updateCoinDisplay() {
            const display = document.getElementById('coins');
            display.textContent = coins !== null ? coins : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        }

        function initYouTubePlayer() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '480',
                width: '270',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                videoDuration = player.getDuration();
                isHalfWatched = false;
                watchedTime = 0;
                startTracking();
            } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                stopTracking();
            }
        }

        function startTracking() {
            interval = setInterval(() => {
                watchedTime++;
                if (watchedTime >= videoDuration / 2 && !isHalfWatched) {
                    isHalfWatched = true;
                    addCoin();
                }
            }, 1000);
        }

        function stopTracking() {
            clearInterval(interval);
        }

        async function addCoin() {
            try {
                const response = await fetch(`/api/add-coin?userId=${userId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                coins = data.coins;
                updateCoinDisplay();
                console.log('–ú–æ–Ω–µ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞. –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:', coins);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–æ–Ω–µ—Ç:', error);
            }
        }

        function toggleTopic(button) {
            const topic = button.value;
            if (selectedTopics.includes(topic)) {
                selectedTopics = selectedTopics.filter(t => t !== topic);
                button.classList.remove("selected");
            } else {
                selectedTopics.push(topic);
                button.classList.add("selected");
            }
        }

        function loadVideos() {
            if (selectedTopics.length === 0) {
                alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–µ–º—É!");
                return;
            }

            const query = selectedTopics.join("|");
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query + " shorts")}&maxResults=50&videoDuration=short&key=${API_KEY}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    videos = data.items.map(item => item.id.videoId);
                    if (videos.length > 0) {
                        shuffleArray(videos);
                        player.loadVideoById(videos[0]);
                    } else {
                        alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã.");
                    }
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:", error);
                    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
                });
        }

        function nextVideo() {
            if (videos.length === 0) return;
            currentIndex = (currentIndex + 1) % videos.length;
            player.loadVideoById(videos[currentIndex]);
        }

        function prevVideo() {
            if (videos.length === 0) return;
            currentIndex = (currentIndex - 1 + videos.length) % videos.length;
            player.loadVideoById(videos[currentIndex]);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
</body>
</html>
