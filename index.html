<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokit - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            color: #ffffff;
        }

        h2 {
            color: #ffffff;
        }

        .topics {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .topic {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            background-color: #444;
            color: #fff;
            transition: background-color 0.3s, transform 0.2s;
        }

        .topic:hover {
            transform: scale(1.05);
        }

        .selected {
            background-color: #ff5722;
            color: white;
        }

        .video-container {
            display: flex;
            justify-content: center;
            margin: 20px auto;
        }

        #videoPlayer {
            width: 320px;
            height: 560px;
            border-radius: 15px;
            overflow: hidden;
            background-color: #000;
        }

        .controls {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            background-color: #333;
            color: #fff;
        }

        .nav-btn:hover {
            background-color: #555;
        }

        .coin-counter {
            font-size: 20px;
            margin-top: 20px;
            color: #ffeb3b;
        }

        .load-btn {
            padding: 12px 24px;
            background-color: #ff5722;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .load-btn:hover {
            background-color: #e64a19;
        }

        .loading {
            display: none;
            margin: 20px 0;
            color: #aaa;
        }
    </style>
</head>
<body>
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–∞—Å —Ç–µ–º—ã:</h2>
    <div class="topics">
        <button class="topic" onclick="toggleTopic(this)" value="sport">üèãÔ∏è –°–ø–æ—Ä—Ç</button>
        <button class="topic" onclick="toggleTopic(this)" value="games">üéÆ –ò–≥—Ä—ã</button>
        <button class="topic" onclick="toggleTopic(this)" value="music">üéµ –ú—É–∑—ã–∫–∞</button>
        <button class="topic" onclick="toggleTopic(this)" value="entertainment">üé≠ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</button>
        <button class="topic" onclick="toggleTopic(this)" value="education">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</button>
        <button class="topic" onclick="toggleTopic(this)" value="tech">üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</button>
        <button class="topic" onclick="toggleTopic(this)" value="vehicles">üöó –ê–≤—Ç–æ</button>
        <button class="topic" onclick="toggleTopic(this)" value="trip">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</button>
        <button class="topic" onclick="toggleTopic(this)" value="food">üçî –ï–¥–∞</button>
        <button class="topic" onclick="toggleTopic(this)" value="health">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</button>
    </div>
    <button class="load-btn" onclick="loadVideos()">–ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ</button>
    <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</div>

    <div class="video-container">
        <video id="videoPlayer" controls></video>
    </div>
    <div class="controls">
        <button class="nav-btn" onclick="prevVideo()">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="nav-btn" onclick="nextVideo()">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
    </div>
    <div class="coin-counter">
        üí∞: <span id="coins">0</span>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const userId = tg.initDataUnsafe?.user?.id; // –ü–æ–ª—É—á–∞–µ–º Telegram ID
        let selectedTopics = [];
        let videos = [];
        let currentIndex = 0;
        let coins = 0;
        let videoDuration = 0;
        let isHalfWatched = false;
        let watchedTime = 0;
        let interval;
        const videoPlayer = document.getElementById('videoPlayer');
        const loadingElement = document.getElementById('loading');

        // –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–º –∏ –ø–∞–ø–æ–∫
        const topicFolders = {
            'sport': 'sport',
            'games': 'games',
            'music': 'music',
            'entertainment': 'entertainment',
            'education': 'education',
            'tech': 'tech',
            'vehicles': 'vehicles',
            'trip': 'trip',
            'food': 'food',
            'health': 'health'
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –≤–∏–¥–µ–æ
        videoPlayer.addEventListener('play', () => {
            videoDuration = videoPlayer.duration;
            isHalfWatched = false;
            watchedTime = 0;
            startTracking();
        });

        videoPlayer.addEventListener('pause', stopTracking);
        videoPlayer.addEventListener('ended', stopTracking);
        videoPlayer.addEventListener('seeked', () => {
            watchedTime = videoPlayer.currentTime;
        });

        function startTracking() {
            interval = setInterval(() => {
                watchedTime++;
                if (watchedTime >= videoDuration / 2 && !isHalfWatched) {
                    isHalfWatched = true;
                    addCoin();
                }
            }, 1000);
        }

        function stopTracking() {
            clearInterval(interval);
        }

        function addCoin() {
            coins++;
            updateCoinDisplay();

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–Ω–µ—Ç –≤ –ë–î
            if (userId) {
                fetch('/api/addCoin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                }).catch(() => {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã');
                });
            }
        }

        function updateCoinDisplay() {
            document.getElementById('coins').textContent = coins;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–Ω–µ—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadCoins() {
            if (!userId) return;
            
            fetch(`/api/coins?user_id=${userId}`)
                .then(res => res.json())
                .then(data => {
                    coins = data.coins ?? 0;
                    updateCoinDisplay();
                });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–º
        function loadVideos() {
            loadCoins();  // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–Ω–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

            if (selectedTopics.length === 0) {
                alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–µ–º—É!");
                return;
            }

            loadingElement.style.display = 'block';
            videos = [];

            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–º
            const requests = selectedTopics.map(topic => {
                const folder = topicFolders[topic];
                return fetch(`/api/videos?topic=${folder}`)
                    .then(response => response.json())
                    .then(videoList => {
                        return videoList.map(video => ({
                            src: `videos/${folder}/${video}`,
                            topic: topic
                        }));
                    });
            });

            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            Promise.all(requests)
                .then(results => {
                    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –≤–∏–¥–µ–æ –≤ –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤
                    results.forEach(videoList => {
                        videos.push(...videoList);
                    });

                    if (videos.length > 0) {
                        shuffleArray(videos);
                        currentIndex = 0;
                        playCurrentVideo();
                    } else {
                        alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã.");
                    }
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:", error);
                    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
                })
                .finally(() => {
                    loadingElement.style.display = 'none';
                });
        }

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ
        function playCurrentVideo() {
            if (videos.length === 0) return;
            
            const video = videos[currentIndex];
            videoPlayer.src = video.src;
            videoPlayer.load();
            videoPlayer.play().catch(e => console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:", e));
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ
        function nextVideo() {
            if (videos.length === 0) return;
            currentIndex = (currentIndex + 1) % videos.length;
            playCurrentVideo();
        }

        function prevVideo() {
            if (videos.length === 0) return;
            currentIndex = (currentIndex - 1 + videos.length) % videos.length;
            playCurrentVideo();
        }

        function toggleTopic(button) {
            const topic = button.value;
            if (selectedTopics.includes(topic)) {
                selectedTopics = selectedTopics.filter(t => t !== topic);
                button.classList.remove("selected");
            } else {
                selectedTopics.push(topic);
                button.classList.add("selected");
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        tg.ready();
    </script>
</body>
</html>
