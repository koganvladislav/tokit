<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokit - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
        padding: 20px;
        background-color: #121212;
        color: #ffffff;
    }

    h2 {
        color: #ffffff;
    }

    .topics {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
    }

    .topic {
        padding: 10px 15px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        background-color: #444;
        color: #fff;
        transition: background-color 0.3s, transform 0.2s;
    }

    .topic:hover {
        transform: scale(1.05);
    }

    .selected {
        background-color: #ff5722;
        color: white;
    }

    .video-container {
        display: flex;
        justify-content: center;
        margin: 20px auto;
    }

    #player {
        width: 320px;
        height: 560px;
        border-radius: 15px;
        overflow: hidden;
    }

    .controls {
        margin-top: 10px;
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .nav-btn {
        padding: 10px 15px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        background-color: #333;
        color: #fff;
    }

    .nav-btn:hover {
        background-color: #555;
    }

    .coin-counter {
        font-size: 20px;
        margin-top: 20px;
        color: #ffeb3b;
    }

    .load-btn {
        padding: 12px 24px;
        background-color: #ff5722;
        color: white;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        margin-bottom: 20px;
    }

    .load-btn:hover {
        background-color: #e64a19;
    }
</style>
</head>
<body>
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–∞—Å —Ç–µ–º—ã:</h2>
    <div class="topics">
        <button class="topic" onclick="toggleTopic(this)" value="—Å–ø–æ—Ä—Ç">üèãÔ∏è –°–ø–æ—Ä—Ç</button>
        <button class="topic" onclick="toggleTopic(this)" value="–∏–≥—Ä—ã">üéÆ –ò–≥—Ä—ã</button>
        <button class="topic" onclick="toggleTopic(this)" value="–º—É–∑—ã–∫–∞">üéµ –ú—É–∑—ã–∫–∞</button>
        <button class="topic" onclick="toggleTopic(this)" value="—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">üé≠ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</button>
        <button class="topic" onclick="toggleTopic(this)" value="–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</button>
        <button class="topic" onclick="toggleTopic(this)" value="—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏">üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</button>
        <button class="topic" onclick="toggleTopic(this)" value="–∞–≤—Ç–æ">üöó –ê–≤—Ç–æ</button>
        <button class="topic" onclick="toggleTopic(this)" value="–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</button>
        <button class="topic" onclick="toggleTopic(this)" value="–µ–¥–∞">üçî –ï–¥–∞</button>
        <button class="topic" onclick="toggleTopic(this)" value="–∑–¥–æ—Ä–æ–≤—å–µ">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</button>
    </div>
    <button class="load-btn" onclick="loadVideos()">–ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ</button>

    <div class="video-container">
        <div id="player"></div>
    </div>
    <div class="controls">
        <button class="nav-btn" onclick="prevVideo()">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="nav-btn" onclick="nextVideo()">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
    </div>
    <div class="coin-counter">
      üí∞: <span id="coins">0</span>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const userId = tg.initDataUnsafe?.user?.id; // –ü–æ–ª—É—á–∞–µ–º Telegram ID
        const API_KEY = "AIzaSyAajvPaSxDC8NMm1Yn50W2V2Ym_TIcm4x8";
        let selectedTopics = [];
        let videos = [];
        let currentIndex = 0;
        let player document.getElementById("player");
        let coins = 0;
        let videoDuration = 0;
        let isHalfWatched = false;
        let watchedTime = 0;
        let interval;

        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–µ–µ—Ä–∞ YouTube
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '480',
                width: '270',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
            updateCoinDisplay();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                videoDuration = player.getDuration();
                isHalfWatched = false;
                watchedTime = 0;
                startTracking();
            } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                stopTracking();
            }
        }

        function startTracking() {
            interval = setInterval(() => {
                watchedTime++;
                if (watchedTime >= videoDuration / 2 && !isHalfWatched) {
                    isHalfWatched = true;
                    addCoin();
                }
            }, 1000);
        }

        function stopTracking() {
            clearInterval(interval);
        }

        function addCoin() {
            coins++;
            updateCoinDisplay();

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–Ω–µ—Ç –≤ –ë–î
            fetch('/api/addCoin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            }).catch(() => {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã');
            });
        }

        function updateCoinDisplay() {
            document.getElementById('coins').textContent = coins;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–Ω–µ—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadCoins() {
            fetch(`/api/coins?user_id=${userId}`)
                .then(res => res.json())
                .then(data => {
                    coins = data.coins ?? 0;
                    updateCoinDisplay();
                });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
        function loadVideos() {
    fetch("/api/videos")
        .then(res => res.json())
        .then(data => {
            videos = data.videos;
            if (videos.length > 0) {
                shuffleArray(videos);
                loadVideo(0);
            } else {
                alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∏–¥–µ–æ");
            }
        });
}
        function loadVideo(index) {
    if (!videos[index]) return;
    player.src = videos[index];
    player.load();
    currentIndex = index;
    isHalfWatched = false;
}
        player.addEventListener('play', () => {
    let duration = player.duration;
    let watched = 0;
    clearInterval(interval);
    interval = setInterval(() => {
        watched++;
        if (watched >= duration / 2 && !isHalfWatched) {
            isHalfWatched = true;
            addCoin();
        }
    }, 1000);
});
        player.addEventListener('pause', () => clearInterval(interval));
player.addEventListener('ended', () => clearInterval(interval));


        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ
        function nextVideo() {
    if (videos.length === 0) return;
    loadVideo((currentIndex + 1) % videos.length);
}

        function prevVideo() {
    if (videos.length === 0) return;
    loadVideo((currentIndex - 1 + videos.length) % videos.length);
}

        function toggleTopic(button) {
            const topic = button.value;
            if (selectedTopics.includes(topic)) {
                selectedTopics = selectedTopics.filter(t => t !== topic);
                button.classList.remove("selected");
            } else {
                selectedTopics.push(topic);
                button.classList.add("selected");
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        tg.ready();

        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    </script>
</body>
</html>
