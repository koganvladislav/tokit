<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tokit1</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background-color: #121212;
      color: #ffffff;
    }

    h2 {
      color: #ffffff;
    }

    .topics {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .topic {
      padding: 10px 15px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
      background-color: #444;
      color: #fff;
      transition: background-color 0.3s, transform 0.2s;
    }

    .topic:hover {
      transform: scale(1.05);
    }

    .selected {
      background-color: #ff5722;
      color: white;
    }

    .video-container {
      display: flex;
      justify-content: center;
      margin: 20px auto;
    }

    #player {
      width: 320px;
      height: 560px;
      border-radius: 15px;
      overflow: hidden;
      background-color: #000;
    }

    .controls {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .nav-btn {
      padding: 10px 15px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
      background-color: #333;
      color: #fff;
    }

    .nav-btn:hover {
      background-color: #555;
    }

    .coin-counter {
      font-size: 20px;
      margin-top: 20px;
      color: #ffeb3b;
    }

    .load-btn {
      padding: 12px 24px;
      background-color: #ff5722;
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .load-btn:hover {
      background-color: #e64a19;
    }
  </style>
</head>
<body>
  <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–∞—Å —Ç–µ–º—ã:</h2>
  <div class="topics">
    <button class="topic" onclick="toggleTopic(this)" value="sport">üèãÔ∏è –°–ø–æ—Ä—Ç</button>
    <button class="topic" onclick="toggleTopic(this)" value="games">üéÆ –ò–≥—Ä—ã</button>
    <button class="topic" onclick="toggleTopic(this)" value="music">üéµ –ú—É–∑—ã–∫–∞</button>
    <button class="topic" onclick="toggleTopic(this)" value="entertainment">üé≠ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</button>
    <button class="topic" onclick="toggleTopic(this)" value="education">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</button>
    <button class="topic" onclick="toggleTopic(this)" value="tech">üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</button>
    <button class="topic" onclick="toggleTopic(this)" value="vehicles">üöó –ê–≤—Ç–æ</button>
    <button class="topic" onclick="toggleTopic(this)" value="trip">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</button>
    <button class="topic" onclick="toggleTopic(this)" value="food">üçî –ï–¥–∞</button>
    <button class="topic" onclick="toggleTopic(this)" value="health">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</button>
  </div>

  <button class="load-btn" onclick="loadVideos()">–ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ</button>

  <div class="video-container">
    <video id="player" controls></video>
  </div>

  <div class="controls">
    <button class="nav-btn" onclick="prevVideo()">‚Üê –ù–∞–∑–∞–¥</button>
    <button class="nav-btn" onclick="nextVideo()">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
  </div>

  <div class="coin-counter">
    üí∞: <span id="coins">0</span>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe?.user?.id;
    const baseUrl = "https://raw.githubusercontent.com/koganvladislav/tokit/main/";

    const videoPaths = {
      education: [...Array(10).keys()].map(i => `${baseUrl}videos/education/video${i + 1}.mp4`),
      entertainment: [...Array(10).keys()].map(i => `${baseUrl}videos/entertainment/video${i + 1}.mp4`),
      food: [...Array(10).keys()].map(i => `${baseUrl}videos/food/video${i + 1}.mp4`),
      games: [...Array(19).keys()].map(i => `${baseUrl}videos/games/video${i + 1}.mp4`),
      health: [...Array(12).keys()].map(i => `${baseUrl}videos/health/video${i + 1}.mp4`),
      music: [...Array(20).keys()].map(i => `${baseUrl}videos/music/video${i + 1}.mp4`),
      sport: [...Array(17).keys()].map(i => `${baseUrl}videos/sport/video${i + 1}.mp4`),
      tech: [...Array(17).keys()].map(i => `${baseUrl}videos/tech/video${i + 1}.mp4`),
      trip: [...Array(13).keys()].map(i => `${baseUrl}videos/trip/video${i + 1}.mp4`),
      vehicles: [...Array(20).keys()].map(i => `${baseUrl}videos/vehicles/video${i + 1}.mp4`)
    };

    let selectedTopics = [];
    let videos = [];
    let currentIndex = 0;
    let coins = 0;
    let videoDuration = 0;
    let isHalfWatched = false;
    let watchInterval;

    function loadCoins() {
      fetch(`/api/coins?user_id=${userId}`)
        .then(res => res.json())
        .then(data => {
          coins = data.coins ?? 0;
          updateCoinDisplay();
        });
    }

    function addCoin() {
      coins++;
      updateCoinDisplay();
      fetch('/api/addCoin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId })
      }).catch(() => {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã');
      });
    }

    function updateCoinDisplay() {
      document.getElementById('coins').textContent = coins;
    }

    async function loadVideos() {
  if (!userId) {
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à Telegram ID.");
    return;
  }

  loadCoins();

  if (selectedTopics.length === 0) {
    alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–µ–º—É!");
    return;
  }

  const allVideos = selectedTopics.flatMap(topic => videoPaths[topic] || []);
  const filtered = [];

  for (const url of allVideos) {
    try {
      const response = await fetch(url, { method: 'HEAD' });
      const size = parseInt(response.headers.get("Content-Length"), 10);
      if (!isNaN(size) && size > 10000) { // 10 KB –º–∏–Ω–∏–º—É–º
        filtered.push(url);
      }
    } catch (e) {
      console.warn(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –≤–∏–¥–µ–æ: ${url}`, e);
    }
  }

  if (filtered.length > 0) {
    videos = filtered;
    shuffleArray(videos);
    currentIndex = 0;
    playVideo(videos[currentIndex]);
  } else {
    alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã.");
  }
}

    function nextVideo() {
      if (videos.length === 0) return;
      currentIndex = (currentIndex + 1) % videos.length;
      playVideo(videos[currentIndex]);
    }

    function prevVideo() {
      if (videos.length === 0) return;
      currentIndex = (currentIndex - 1 + videos.length) % videos.length;
      playVideo(videos[currentIndex]);
    }

    function playVideo(videoUrl) {
      const player = document.getElementById('player');
      player.src = videoUrl;
      player.load();
      isHalfWatched = false;

      player.onloadedmetadata = () => {
        videoDuration = player.duration;
        startTracking(player);
      };

      player.play().catch(e => console.log("–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ:", e));

      player.onended = function () {
        stopTracking();
        coins += 1;
        updateCoinDisplay();
        fetch(`/api/add-coins?user_id=${userId}&amount=1`, { method: 'POST' });
      };
    }

    function startTracking(player) {
      stopTracking();
      watchInterval = setInterval(() => {
        if (!isHalfWatched && player.currentTime >= videoDuration / 2) {
          isHalfWatched = true;
          addCoin();
        }
      }, 1000);
    }

    function stopTracking() {
      clearInterval(watchInterval);
    }

    function toggleTopic(button) {
      const topic = button.value;
      if (selectedTopics.includes(topic)) {
        selectedTopics = selectedTopics.filter(t => t !== topic);
        button.classList.remove("selected");
      } else {
        selectedTopics.push(topic);
        button.classList.add("selected");
      }
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    tg.ready();
  </script>
</body>
</html>
