<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokit - Telegram Mini App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            color: #ffffff;
        }

        h2 {
            color: #ffffff;
        }

        .topics {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .topic {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            background-color: #444;
            color: #fff;
            transition: background-color 0.3s, transform 0.2s;
        }

        .topic:hover {
            transform: scale(1.05);
        }

        .selected {
            background-color: #ff5722;
            color: white;
        }

        .video-container {
            display: flex;
            justify-content: center;
            margin: 20px auto;
        }

        #player {
            width: 320px;
            height: 560px;
            border-radius: 15px;
            overflow: hidden;
        }

        .controls {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            background-color: #333;
            color: #fff;
        }

        .nav-btn:hover {
            background-color: #555;
        }

        .coin-counter {
            font-size: 20px;
            margin-top: 20px;
            color: #ffeb3b;
        }

        .load-btn {
            padding: 12px 24px;
            background-color: #ff5722;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .load-btn:hover {
            background-color: #e64a19;
        }
    </style>
</head>
<body>
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–∞—Å —Ç–µ–º—ã:</h2>
    <div class="topics">
        <button class="topic" value="—Å–ø–æ—Ä—Ç">üèãÔ∏è –°–ø–æ—Ä—Ç</button>
        <button class="topic" value="–∏–≥—Ä—ã">üéÆ –ò–≥—Ä—ã</button>
        <button class="topic" value="–º—É–∑—ã–∫–∞">üéµ –ú—É–∑—ã–∫–∞</button>
        <button class="topic" value="—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">üé≠ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</button>
        <button class="topic" value="–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</button>
        <button class="topic" value="—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏">üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</button>
        <button class="topic" value="–∞–≤—Ç–æ">üöó –ê–≤—Ç–æ</button>
        <button class="topic" value="–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</button>
        <button class="topic" value="–µ–¥–∞">üçî –ï–¥–∞</button>
        <button class="topic" value="–∑–¥–æ—Ä–æ–≤—å–µ">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</button>
    </div>
    <button class="load-btn" onclick="loadVideos()">–ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ</button>

    <div class="video-container">
        <div id="player"></div>
    </div>
    <div class="controls">
        <button class="nav-btn" onclick="prevVideo()">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="nav-btn" onclick="nextVideo()">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
    </div>
    <div class="coin-counter">
      üí∞: <span id="coins">0</span>
    </div>

    <script>
        let selectedTopics = [];
        let videos = [];
        let currentIndex = 0;
        let player;
        let coins = 0;
        let videoDuration = 0;
        let isHalfWatched = false;
        let watchedTime = 0;
        let interval;

        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–µ–µ—Ä–∞ YouTube
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '480',
                width: '270',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
            updateCoinDisplay();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                videoDuration = player.getDuration();
                isHalfWatched = false;
                watchedTime = 0;
                startTracking();
            } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                stopTracking();
            }
        }

        function startTracking() {
            interval = setInterval(() => {
                watchedTime++;
                if (watchedTime >= videoDuration / 2 && !isHalfWatched) {
                    isHalfWatched = true;
                    addCoin();
                }
            }, 1000);
        }

        function stopTracking() {
            clearInterval(interval);
        }

        function addCoin() {
            coins++;
            updateCoinDisplay();
        }

        function updateCoinDisplay() {
            document.getElementById('coins').textContent = coins;
        }

        function loadVideos() {
            if (selectedTopics.length === 0) {
                alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–µ–º—É!");
                return;
            }

            // –ó–¥–µ—Å—å –∏–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ç–µ–º–∞–º.
            const query = selectedTopics.join("|");
            // –ü–æ–¥—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–¥–µ–æ.
            fetch(`/api/videos?topic=${query}`)
                .then(response => response.json())
                .then(data => {
                    videos = data;
                    if (videos.length > 0) {
                        shuffleArray(videos);
                        // –ó–¥–µ—Å—å –≤–∏–¥–µ–æ –±—É–¥–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞.
                        player.loadVideoById(videos[0]);
                    } else {
                        alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã.");
                    }
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:", error);
                    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ
        function nextVideo() {
            if (videos.length === 0) return;
            currentIndex = (currentIndex + 1) % videos.length;
            player.loadVideoById(videos[currentIndex]);
        }

        function prevVideo() {
            if (videos.length === 0) return;
            currentIndex = (currentIndex - 1 + videos.length) % videos.length;
            player.loadVideoById(videos[currentIndex]);
        }

        function toggleTopic(button) {
            const topic = button.value;
            if (selectedTopics.includes(topic)) {
                selectedTopics = selectedTopics.filter(t => t !== topic);
                button.classList.remove("selected");
            } else {
                selectedTopics.push(topic);
                button.classList.add("selected");
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.topic').forEach(button => {
            button.addEventListener('click', function() {
                toggleTopic(this);
            });
        });
    </script>

    <script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
