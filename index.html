<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokit - Telegram Mini App</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
        padding: 20px;
        background-color: #121212;
        color: #ffffff;
    }

    h2 {
        color: #ffffff;
    }

    .topics {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
    }

    .topic {
        padding: 10px 15px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        background-color: #444;
        color: #fff;
        transition: background-color 0.3s, transform 0.2s;
    }

    .topic:hover {
        transform: scale(1.05);
    }

    .selected {
        background-color: #ff5722;
        color: white;
    }

    .video-container {
        display: flex;
        justify-content: center;
        margin: 20px auto;
    }

    #player {
        width: 320px;
        height: 560px;
        border-radius: 15px;
        overflow: hidden;
    }

    .controls {
        margin-top: 10px;
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .nav-btn {
        padding: 10px 15px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        background-color: #333;
        color: #fff;
    }

    .nav-btn:hover {
        background-color: #555;
    }

    .coin-counter {
        font-size: 20px;
        margin-top: 20px;
        color: #ffeb3b;
    }

    .load-btn {
        padding: 12px 24px;
        background-color: #ff5722;
        color: white;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        margin-bottom: 20px;
    }

    .load-btn:hover {
        background-color: #e64a19;
    }
</style>
</head>
<body>
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–∞—Å —Ç–µ–º—ã:</h2>
    <div class="topics">
        <button class="topic" onclick="toggleTopic(this)" value="—Å–ø–æ—Ä—Ç">üèãÔ∏è –°–ø–æ—Ä—Ç</button>
        <button class="topic" onclick="toggleTopic(this)" value="–∏–≥—Ä—ã">üéÆ –ò–≥—Ä—ã</button>
        <button class="topic" onclick="toggleTopic(this)" value="–º—É–∑—ã–∫–∞">üéµ –ú—É–∑—ã–∫–∞</button>
        <button class="topic" onclick="toggleTopic(this)" value="—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">üé≠ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</button>
        <button class="topic" onclick="toggleTopic(this)" value="–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</button>
        <button class="topic" onclick="toggleTopic(this)" value="—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏">üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</button>
        <button class="topic" onclick="toggleTopic(this)" value="–∞–≤—Ç–æ">üöó –ê–≤—Ç–æ</button>
        <button class="topic" onclick="toggleTopic(this)" value="–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</button>
        <button class="topic" onclick="toggleTopic(this)" value="–µ–¥–∞">üçî –ï–¥–∞</button>
        <button class="topic" onclick="toggleTopic(this)" value="–∑–¥–æ—Ä–æ–≤—å–µ">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</button>
    </div>
    <button class="load-btn" onclick="loadVideos()">–ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ</button>

    <div class="video-container">
        <video id="player" controls>
            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç video.
        </video>
    </div>
    <div class="controls">
        <button class="nav-btn" onclick="prevVideo()">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="nav-btn" onclick="nextVideo()">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
    </div>
    <div class="coin-counter">
      üí∞: <span id="coins">0</span>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const userId = tg.initDataUnsafe?.user?.id; // –ü–æ–ª—É—á–∞–µ–º Telegram ID
        let selectedTopics = [];
        let videos = [];
        let currentIndex = 0;
        let coins = 0;

        const topicsToFolder = {
            —Å–ø–æ—Ä—Ç: 'sport',
            –∏–≥—Ä—ã: 'games',
            –º—É–∑—ã–∫–∞: 'music',
            —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è: 'entertainment',
            –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: 'education',
            —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏: 'tech',
            –∞–≤—Ç–æ: 'vehicles',
            –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è: 'trip',
            –µ–¥–∞: 'food',
            –∑–¥–æ—Ä–æ–≤—å–µ: 'health'
        };

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–Ω–µ—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadCoins() {
            fetch(`/api/coins?user_id=${userId}`)
                .then(res => res.json())
                .then(data => {
                    coins = data.coins ?? 0;
                    updateCoinDisplay();
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–Ω–µ—Ç
        function updateCoinDisplay() {
            document.getElementById('coins').textContent = coins;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        function loadVideos() {
            if (!userId) {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à Telegram ID.");
                return;
            }

            loadCoins();  // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–Ω–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

            if (selectedTopics.length === 0) {
                alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–µ–º—É!");
                return;
            }

            const videoFolder = selectedTopics.map(topic => topicsToFolder[topic]);
            let allVideos = [];

            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–∏–¥–µ–æ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞–ø–æ–∫
            videoFolder.forEach(folder => {
                fetch(`/api/videos?topic=${folder}`)
                    .then(res => res.json())
                    .then(files => {
                        allVideos = [...allVideos, ...files];
                        if (allVideos.length > 0) {
                            shuffleArray(allVideos);
                            loadVideo(allVideos[0]);
                        } else {
                            alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã.");
                        }
                    })
                    .catch(() => alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ"));
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –≤ –ø–ª–µ–µ—Ä
        function loadVideo(videoFile) {
            const player = document.getElementById('player');
            player.src = `/videos/${videoFile}`;
            player.play();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ –≤–∏–¥–µ–æ
        function nextVideo() {
            if (videos.length === 0) return;
            currentIndex = (currentIndex + 1) % videos.length;
            loadVideo(videos[currentIndex]);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–∏–¥–µ–æ
        function prevVideo() {
            if (videos.length === 0) return;
            currentIndex = (currentIndex - 1 + videos.length) % videos.length;
            loadVideo(videos[currentIndex]);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º—ã
        function toggleTopic(button) {
            const topic = button.value;
            if (selectedTopics.includes(topic)) {
                selectedTopics = selectedTopics.filter(t => t !== topic);
                button.classList.remove("selected");
            } else {
                selectedTopics.push(topic);
                button.classList.add("selected");
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –º–∞—Å—Å–∏–≤–∞
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
</body>
</html>
